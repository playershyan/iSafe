generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PERSONS (In Shelters)
// ============================================================================

model Person {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Basic Info
  fullName        String    @map("full_name")
  age             Int
  gender          Gender
  nic             String?   @unique
  contactNumber   String?   @map("contact_number")

  // Location
  shelterId       String    @map("shelter_id")
  shelter         Shelter   @relation(fields: [shelterId], references: [id])

  // Health
  healthStatus    HealthStatus @map("health_status")
  specialNotes    String?   @map("special_notes")

  // Photo
  photoUrl        String?   @map("photo_url")
  photoPublicId   String?   @map("photo_public_id")

  // Matching
  missingReportId String?   @map("missing_report_id")
  missingReport   MissingPerson? @relation(fields: [missingReportId], references: [id])
  matchedAt       DateTime? @map("matched_at")

  @@index([fullName])
  @@index([nic])
  @@index([shelterId])
  @@map("persons")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum HealthStatus {
  HEALTHY
  MINOR_INJURIES
  REQUIRES_CARE
  CRITICAL
}

// ============================================================================
// MISSING PERSONS (Reports)
// ============================================================================

model MissingPerson {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Person Details
  fullName          String    @map("full_name")
  age               Int
  gender            Gender
  nic               String?
  photoUrl          String?   @map("photo_url")
  photoPublicId     String?   @map("photo_public_id")

  // Last Known
  lastSeenLocation  String    @map("last_seen_location")
  lastSeenDistrict  String?   @map("last_seen_district")  // Made optional as removed from form
  lastSeenDate      DateTime  @map("last_seen_date") // Made required
  clothing          String?   // Used for description field

  // Reporter Details
  reporterName      String    @map("reporter_name")
  reporterPhone     String    @map("reporter_phone")
  altContact        String?   @map("alt_contact")

  // Status
  status            MissingStatus @default(MISSING)
  foundPersons      Person[]

  // Poster
  posterCode        String    @unique @map("poster_code")
  posterUrl         String?   @map("poster_url")

  // Anonymous User Tracking
  anonymousUserId   String?   @map("anonymous_user_id")

  @@index([fullName])
  @@index([nic])
  @@index([posterCode])
  @@index([status])
  @@index([anonymousUserId])
  @@map("missing_persons")
}

enum MissingStatus {
  MISSING
  FOUND
  CLOSED
}

// ============================================================================
// SHELTERS
// ============================================================================

model Shelter {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Basic Info
  name            String
  code            String    @unique
  district        String
  address         String?

  // Contact
  contactPerson   String?   @map("contact_person")
  contactNumber   String?   @map("contact_number")

  // Capacity
  capacity        Int?
  currentCount    Int       @default(0) @map("current_count")

  // Status
  isActive        Boolean   @default(true) @map("is_active")

  // Relations
  persons         Person[]
  auth            ShelterAuth?

  @@index([code])
  @@index([district])
  @@map("shelters")
}

// ============================================================================
// SHELTER STAFF / AUTH
// ============================================================================

model ShelterAuth {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  shelterId       String    @unique @map("shelter_id")
  shelter         Shelter   @relation(fields: [shelterId], references: [id])
  accessCode      String    @map("access_code")

  // Audit
  lastAccessAt    DateTime? @map("last_access_at")
  accessCount     Int       @default(0) @map("access_count")

  @@index([accessCode])
  @@map("shelter_auth")
}

// ============================================================================
// MATCHES (Audit Trail)
// ============================================================================

model Match {
  id                String    @id @default(cuid())
  createdAt         DateTime  @default(now()) @map("created_at")
  matchedAt         DateTime  @default(now()) @map("matched_at")

  missingPersonId   String    @map("missing_person_id")
  personId          String    @map("person_id")

  // Match quality
  matchScore        Int       @map("match_score")
  matchedBy         MatchMethod @default(AUTOMATIC) @map("matched_by")

  // Confirmation
  confirmedAt       DateTime? @map("confirmed_at")
  confirmedBy       String?   @map("confirmed_by")

  // Notification
  notificationSent  Boolean   @default(false) @map("notification_sent")
  notifiedAt        DateTime? @map("notified_at")

  @@index([missingPersonId])
  @@index([personId])
  @@map("matches")
}

enum MatchMethod {
  MANUAL
  AUTOMATIC
  PHOTO_MATCH
}

// ============================================================================
// STATISTICS (Cached)
// ============================================================================

model Statistics {
  id                String    @id @default("singleton")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  totalPersons      Int       @default(0) @map("total_persons")
  totalShelters     Int       @default(0) @map("total_shelters")
  activeShelters    Int       @default(0) @map("active_shelters")
  totalMissing      Int       @default(0) @map("total_missing")
  totalMatches      Int       @default(0) @map("total_matches")

  // Per district
  byDistrict        Json      @map("by_district")

  @@map("statistics")
}
